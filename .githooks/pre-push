#!/usr/bin/env bash

set -euo pipefail

ZERO_OID="0000000000000000000000000000000000000000"

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

# Preserve stdin once so both git-lfs and custom gate logic can read it.
hook_input_file="$(mktemp)"
trap 'rm -f "$hook_input_file"' EXIT
cat >"$hook_input_file"

# Run Git LFS upload hook when available.
if command -v git-lfs >/dev/null 2>&1; then
  git lfs pre-push "$@" <"$hook_input_file"
fi

is_resume_affecting_path() {
  local file_path="$1"

  case "$file_path" in
    lib/resume-data.ts|\
    app/styles/13-resume-latex.css|\
    components/tiles/content/ResumeContent.tsx|\
    components/tiles/content/resume/*|\
    app/resume/page.tsx|\
    scripts/generate-resume-pdfs.mjs|\
    scripts/validate-resume-pdfs.mjs|\
    scripts/verify-resume-layout.mjs|\
    scripts/calibrate-resume-layout.mjs|\
    scripts/measure-resume-bottom-whitespace.mjs|\
    scripts/lib/resume-pdf-variants.mjs)
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

collect_changed_files() {
  local local_sha="$1"
  local remote_sha="$2"

  if [[ "$remote_sha" == "$ZERO_OID" ]]; then
    git rev-list "$local_sha" --not --remotes | while IFS= read -r commit_sha; do
      git diff-tree --no-commit-id --name-only -r "$commit_sha"
    done
  else
    git diff --name-only "$remote_sha" "$local_sha"
  fi
}

run_build_with_retry() {
  local attempt=1
  local max_attempts=2

  while true; do
    local resume_pdf_port=$((RANDOM % 1000 + 3200))

    if RESUME_PDF_PORT="$resume_pdf_port" npm run build; then
      return 0
    fi

    if [[ "$attempt" -ge "$max_attempts" ]]; then
      echo "[pre-push] npm run build failed after ${max_attempts} attempts."
      return 1
    fi

    echo "[pre-push] npm run build failed on attempt ${attempt}. Retrying..."
    attempt=$((attempt + 1))
    sleep 1
  done
}

resume_changed=0

while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ -z "${local_ref:-}" || "$local_sha" == "$ZERO_OID" ]]; then
    continue
  fi

  while IFS= read -r changed_file; do
    if [[ -n "$changed_file" ]] && is_resume_affecting_path "$changed_file"; then
      resume_changed=1
      break 2
    fi
  done < <(collect_changed_files "$local_sha" "$remote_sha")
done <"$hook_input_file"

if [[ "$resume_changed" -eq 0 ]]; then
  echo "[pre-push] No resume-affecting changes detected in push range. Skipping resume gate."
  exit 0
fi

if [[ "${RESUME_HOOK_TEST_MODE:-0}" == "1" ]]; then
  echo "[pre-push] Resume-affecting changes detected. Test mode enabled; gate would run."
  exit 0
fi

echo "[pre-push] Resume-affecting changes detected. Running resume gate..."

status_before="$(git status --porcelain | sort)"

run_build_with_retry
npm run calibrate:resume-layout

status_after="$(git status --porcelain | sort)"

if [[ "$status_before" != "$status_after" ]]; then
  echo "[pre-push] calibrate:resume-layout changed tracked files."
  echo "[pre-push] Commit those changes, then push again."
  git status --short
  exit 1
fi

npm run verify:resume-layout
npm run validate-resume-pdfs

echo "[pre-push] Resume gate passed."
